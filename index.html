<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Přidání stylu pro modální okno */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999; /* Zajisti, aby bylo modální okno nad mapou */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #playerPanel {
            flex: 1;
            padding: 10px;
            background-color: #f0f0f0;
        }

        #map {
            flex: 2;
            height: 100%;
        }
</style>
    <title>Train Game</title>
</head>
<body>

<div id="playerPanel">
    <!-- Zde můžete umístit obsah hráčova panelu, např. portfolio, kupony vlaků, atd. -->
    <div id="playerPanel">
        <h2>Player Panel</h2>
        <p id="finance">Finance: 500000 Kč</p>
        <p>Kupony vlaků: 0A6</p>
        <button id="buyTrainButton">Nakupovat vlaky</button>
        <div id="buyTrainModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Výběr vlaku</h2>
            </div>
        </div>
    </div>
   
    <!-- Doplnit další informace podle potřeby -->
</div>

<div id="map"></div> 



<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let playerFinance = 500000;
let availableLines = []; // Seznam dostupných linek
 let currentTrainType;
 

const updateInterval = 1000; // Interval aktualizace polohy vlaku v ms
const offerInterval = 20000; // Interval nabídek od herního drážního úřadu v ms

// Fiktivní data pro linky a zastávky
const lines = [
    {
        name: "Trať 192 STRÁŽSKÉ - TREBIŠOV",
        color: "red",
        category: "A",
        trains: [
            { name: "Train 1", startingIndex: 0, reverse: false, image: 'https://i.imgur.com/sgF74F8.png', maxSpeed: 600 },
            { name: "Train 2", startingIndex: 8, reverse: false, image: 'https://i.imgur.com/5V3WrS7.png', maxSpeed: 600 },
            
        ],
         stops: [
                { name: "Strážské", location: [48.8675378, 21.8248364] },
                { name: "Nižný Hrabovec", location: [48.8570392, 21.7518606] },  
                { name: "Hencovce", location: [48.8570392, 21.7518606] },
                { name: "Vranovské Dlhé", location: [48.8695603, 21.7053108] },   
                { name: "Michalovce", location: [48.7505264, 21.8986283] },
                { name: "Michalovce zastávka", location: [48.7298264, 21.8870664] },
                 { name: "Bánovce nad Ondavou", location: [48.6792981, 21.8347850] },
                { name: "Hrinište", location: [48.6522875, 21.7758247] },
                { name: "Trebišov ŠRT", location: [48.6435381, 21.7411311] },
                { name: "Trebišov", location: [48.6329881, 21.7118856] },  
                ]
    },  
     {
        name: "Trať 198 Humenné - TREBIŠOV",
        color: "blue",
        category: "A",
        trains: [
            { name: "Train 1", startingIndex: 0, reverse: false, image: 'https://i.imgur.com/sgF74F8.png', maxSpeed: 600 },
            { name: "Train 2", startingIndex: 8, reverse: false, image: 'https://i.imgur.com/5V3WrS7.png', maxSpeed: 600 },
            
        ],
         stops: [
                 { name: "Humenné", location: [48.9300233, 21.9008925] },
                { name: "Brekov", location: [48.9032003, 21.8414797] },  
                { name: "Strážské", location: [48.8675378, 21.8248364] },
                { name: "Pusté Čemerné", location: [48.8432156, 21.8274414] },  
                { name: "Nacina Ves", location: [48.8177800, 21.8437733] },
                { name: "Petrovce nad Laborcom", location: [48.7976722, 21.8602528] },   
                { name: "Michalovce", location: [48.7505264, 21.8986283] },
                { name: "Michalovce zastávka", location: [48.7298264, 21.8870664] },
                 { name: "Bánovce nad Ondavou", location: [48.6792981, 21.8347850] },
                { name: "Hrinište", location: [48.6522875, 21.7758247] },
                { name: "Trebišov ŠRT", location: [48.6435381, 21.7411311] },
                { name: "Trebišov", location: [48.6329881, 21.7118856] },  
                ]
    },  
    // Další linky můžete přidávat podle potřeby
];

// Inicializace mapy Leaflet
const map = L.map('map').setView([49.25, 13.91], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Skrytí linek na začátku hry
lines.forEach(line => {
    line.hidden = true;
    availableLines.push(line);
});

      // Přidání skriptu pro otevření modálního okna
        document.getElementById('buyTrainButton').addEventListener('click', () => openModal('TrainType1'));

        function openModal(trainType) {
            document.getElementById('buyTrainModal').style.display = 'block';
            // Nastavíme aktuální typ vlaku do globální proměnné
            currentTrainType = trainType;
            // Získáme informace o vlaku na základě aktuálního typu
            const trainInfo = getTrainInfo(currentTrainType);
            // Změníme nadpis modálního okna na aktuální typ vlaku
            document.querySelector('.modal-content h2').innerText = `Výběr vlaku - ${trainInfo.name}`;
            // Vytvoříme tlačítka pro nákup více vlaků
            createBuyButtons(trainInfo.trains);
        }

       // Nová funkce pro nákup vlaků
function buyTrains(trainType, trainIndex) {
    const trainInfo = trainData[trainType];
    const selectedTrain = trainInfo.trains[trainIndex];

    if (playerFinance >= selectedTrain.price) {
        playerFinance -= selectedTrain.price;
        document.getElementById('finance').innerText = `Finance: ${playerFinance} Kč`;
        
        
        const newTrain = {
            id: generateUniqueId(),
            type: trainType,
            name: selectedTrain.name,
            price: selectedTrain.price,
            imgUrl: selectedTrain.imgUrl,
            // Další vlastnosti vlaku
        };
        playerInventory.push(newTrain);

        // Zjistíme pozici stanice Michalovce
        const michalovceStation = { lat: 48.7505264, lon: 21.8986283 };

        // Přidáme nový marker (vlak) na pozici stanice Michalovce
       const trainMarker = L.marker([michalovceStation.lat, michalovceStation.lon], { icon: selectedTrain.icon }).addTo(map);
    trainMarker.bindPopup(`Vlak ${newTrain.name}`);

        // Přidáme do inventáře informace o umístění vlaku
      newTrain.location = { lat: michalovceStation.lat, lon: michalovceStation.lon };

        alert(`Gratulujeme! Zakoupil jsi nový vlak typu ${trainType} - ${selectedTrain.name}.`);

        // Odstraníme tuto možnost z tlačítka
        trainInfo.trains.splice(trainIndex, 1);
        // Znovu vygenerujeme tlačítka pro nákup
        createBuyButtons(trainInfo.trains);
    } else {
        alert("Nemáte dostatek financí na nákup tohoto vlaku.");
    }
}
        function createBuyButtons(trains) {
    // Najdeme kontejner pro tlačítka v modálním okně
    const buttonsContainer = document.querySelector('.modal-content');
    // Odstraníme všechna existující tlačítka z modálního okna
    buttonsContainer.querySelectorAll('button.buyTrainButton').forEach(button => button.remove());
    // Pro každý vlak vytvoříme tlačítko
    trains.forEach((train, index) => {
        const button = document.createElement('button');
        button.className = 'buyTrainButton';
        button.innerText = `Koupit vlak - ${train.name} za ${train.price} Kč`;
        button.addEventListener('click', () => buyTrains(currentTrainType, index));
        // Přidáme tlačítko do modálního okna
        buttonsContainer.appendChild(button);
    });
}

        // Funkce pro zavření modálního okna
        function closeModal() {
            document.getElementById('buyTrainModal').style.display = 'none';
        }

        // Funkce pro přidání nového vlaku do inventáře hráče
        function addTrainToInventory(trainType, trainIndex) {
            const trainInfo = getTrainInfo(trainType);
            const selectedTrain = trainInfo.trains[trainIndex];

            // Přidání nového vlaku do inventáře hráče
            const newTrain = {
                id: generateUniqueId(), // Generování unikátního identifikátoru pro vlak
                type: trainType,
                name: selectedTrain.name,
                speed: selectedTrain.maxSpeed, // Předpokládáme, že rychlost vlaku je jeho hlavní vlastnost
                capacity: selectedTrain.capacity, // Předpokládáme, že kapacita vlaku je jeho hlavní vlastnost
                // Další vlastnosti vlaku, které bys mohl chtít ukládat
            };

            // Zde bys mohl přidat další logiku pro aktualizaci inventáře nebo jiné akce
            playerInventory.push(newTrain);

            alert(`Gratulujeme! Vlak ${newTrain.name} byl přidán do tvého inventáře.`);
        }

        // Funkce pro generování unikátního identifikátoru (jednoduchý příklad)
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Funkce pro získání informací o vlaku na základě jeho typu
        function getTrainInfo(trainType) {
            // Tato funkce by měla vrátit informace o vlaku na základě zadaného typu
            // Zde by měla být implementace, která získá potřebné informace (název, cenu, obrázek, atd.) z dat nebo serveru
            // Pro účely příkladu použijeme jednoduché statické informace
            const trainData = {
                TrainType1: {
                    name: 'Vlak 751 017',
                    trains: [
                        { name: '751 017', price: 5000, imgUrl: 'https://i.imgur.com/PYQfds5.png' },
                        { name: '752 040', price: 6000, imgUrl: 'https://i.imgur.com/PYquoig.png' }
                    ]
                },
                TrainType2: {
                    name: 'Vlak 751 195',
                    trains: [
                        { name: '751 195', price: 50000, imgUrl: 'https://i.imgur.com/3Vz0jG7.png' },
                        { name: '751 154', price: 75000, imgUrl: 'https://i.imgur.com/d8pHGVD.png' }
                    ]
                }
                // ... další typy vlaků
            };

            // Přiřazení ikon vlakům


// Přiřazení ikon vlakům
Object.keys(trainData).forEach(trainType => {
    trainData[trainType].trains.forEach(train => {
        train.icon = L.icon({
            iconUrl: train.imgUrl,
            iconSize: [50, 50],
            iconAnchor: [25, 25],
            popupAnchor: [0, 0],
        });
    });
});

// Přidání skriptu pro otevření modálního okna
document.getElementById('buyTrainButton').addEventListener('click', ()
            return trainData[trainType];
        }

   let playerInventory = [];

// Funkce pro přidání nového vlaku do inventáře hráče
function addTrainToInventory(trainType, trainIndex) {
    const trainInfo = getTrainInfo(trainType);
    const selectedTrain = trainInfo.trains[trainIndex];

    // Přidání nového vlaku do inventáře hráče
    const newTrain = {
        id: generateUniqueId(), // Generování unikátního identifikátoru pro vlak
        type: trainType,
        name: selectedTrain.name,
        speed: selectedTrain.maxSpeed, // Předpokládáme, že rychlost vlaku je jeho hlavní vlastnost
        capacity: selectedTrain.capacity, // Předpokládáme, že kapacita vlaku je jeho hlavní vlastnost
        // Další vlastnosti vlaku, které bys mohl chtít ukládat
    };

    playerInventory.push(newTrain);

    // Zde bys mohl přidat další logiku pro aktualizaci inventáře nebo jiné akce

    alert(`Gratulujeme! Vlak ${newTrain.name} byl přidán do tvého inventáře.`);
}

// Funkce pro generování unikátního identifikátoru (jednoduchý příklad)
function generateUniqueId() {
    return '_' + Math.random().toString(36).substr(2, 9);
}
 
function showRandomOffer() {
    const randomLineIndex = Math.floor(Math.random() * availableLines.length);
    const offerLine = availableLines[randomLineIndex];

    let offerPrice, earningMin, earningMax;

    switch (offerLine.category) {
        case "A":
            offerPrice = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;
            earningMin = 100;
            earningMax = 200;
            break;
        case "B":
            offerPrice = Math.floor(Math.random() * (50000 - 30000 + 1)) + 30000;
            earningMin = 300;
            earningMax = 500;
            break;
        case "C":
            offerPrice = Math.floor(Math.random() * (100000 - 80000 + 1)) + 80000;
            earningMin = 500;
            earningMax = 800;
            break;
        case "D":
            offerPrice = Math.floor(Math.random() * (200000 - 180000 + 1)) + 180000;
            earningMin = 1000;
            earningMax = 1500;
            break;
        default:
            offerPrice = 0;
            earningMin = 0;
            earningMax = 0;
            break;
    }

     if (confirm(`Herní drážní úřad nabízí provozování linky: ${offerLine.name} za ${offerPrice} Kč. Chcete ji koupit?`)) {
        if (playerFinance >= offerPrice) {
            playerFinance -= offerPrice;
            document.getElementById('finance').innerText = `Finance: ${playerFinance} Kč`;

            offerLine.hidden = false;
            availableLines.splice(randomLineIndex, 1);

            // Přidání ikon a logiky pro nově zakoupenou linku
            let polyline = L.polyline(offerLine.stops.map(stop => stop.location), { color: offerLine.color }).addTo(map);
            polyline.bindPopup(offerLine.name);

            offerLine.trains.forEach(train => {
                let trainIcon = L.icon({
                    iconUrl: train.image,
                    iconSize: [100, 100],
                    iconAnchor: [50, 50],
                    popupAnchor: [0, 0]
                });

                let trainMarker = L.marker(offerLine.stops[train.startingIndex].location, { icon: trainIcon }).addTo(map);
                trainMarker.bindPopup(train.name);

                train.marker = trainMarker; // Uložení markeru do dat vlaku

                // Spuštění pohybu vlaků na nové lince
                moveTrain(train, offerLine);
            });

            offerLine.stops.forEach(stop => {
                L.marker(stop.location, { icon: stopIcon }).addTo(map).bindPopup(stop.name);
            });
        } else {
            alert("Nemáte dostatek financí na zakoupení této linky.");
        }
    }
}
    
function moveTrain(train, line) {
    let currentStopIndex = train.startingIndex;
    let direction = train.reverse ? -1 : 1; // Směr pohybu vlaku (1 = dopředu, -1 = zpět)
    let startTime = new Date();

    setInterval(() => {
        const currentStop = line.stops[currentStopIndex];
        const nextStop = line.stops[currentStopIndex + direction];

        if (nextStop) {
            const distanceToNextStop = getDistance(currentStop.location[0], currentStop.location[1], nextStop.location[0], nextStop.location[1]);
            const timeToNextStop = distanceToNextStop / train.maxSpeed; // Vypočítat čas na základě maxSpeed vlaku

            const currentTime = new Date();
            const elapsedTime = (currentTime - startTime) / 1000 / 60 / 60;

            if (elapsedTime <= timeToNextStop) {
                const lat = currentStop.location[0] + (nextStop.location[0] - currentStop.location[0]) * (elapsedTime / timeToNextStop);
                const lon = currentStop.location[1] + (nextStop.location[1] - currentStop.location[1]) * (elapsedTime / timeToNextStop);
                train.marker.setLatLng([lat, lon]);
            } else {
                currentStopIndex += direction;
                startTime = new Date();

                if (currentStopIndex === 0 || currentStopIndex === line.stops.length - 1) {
                    direction *= -1;
                    giveRandomMoneyToPlayer(line.category);
                }
            }
        } else {
            direction *= -1;
            currentStopIndex += direction;
            giveRandomMoneyToPlayer(line.category);
        }
    }, updateInterval);
}
    // Spuštění nabídek od herního drážního úřadu každou minutu
setInterval(showRandomOffer, offerInterval);

    
// Funkce pro udělení náhodné finanční částky hráči při dosažení zastávky
function giveRandomMoneyToPlayer(category) {
    const randomAmount = generateRandomAmount(category);
    playerFinance += randomAmount;
    document.getElementById('finance').innerText = `Finance: ${playerFinance} Kč`;
}

function generateRandomAmount(category) {
    let earningMin, earningMax;

    switch (category) {
        case "A":
            earningMin = 500;
            earningMax = 800;
            break;
        case "B":
            earningMin = 2000;
            earningMax = 2500;
            break;
        case "C":
            earningMin = 7000;
            earningMax = 10000;
            break;
        case "D":
            earningMin = 10000;
            earningMax = 15000;
            break;
        default:
            earningMin = 0;
            earningMax = 0;
            break;
    }

    return Math.floor(Math.random() * (earningMax - earningMin + 1)) + earningMin;
}



// Vypočítá vzdálenost mezi dvěma zastávkami
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // poloměr Země v km
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c; // vzdálenost v km
    return distance;
}

// Převádí stupně na radiány
function toRadians(degrees) {
    return degrees * Math.PI / 180;
}

</script>

</body>
</html>
